// Extensible error filters

'use strict';

var includes   = require('es5-ext/string/#/contains');

var varsBlackList = ['clearOverlappingSelection', 'clearSelection', 'initMultiSelection', 'jQuery'];
var sourceBlackList = ['http://cdn.montiera.com', 'livechat-v'];

module.exports = exports = function () {
	var context = this, args = arguments;
	return exports.filters.every(function (filter) { return filter.callback.apply(context, args); });
};

exports.filters = [{
	// Ignore errors send by googlebot
	name: 'googleBot',
	callback: function (data) {
		return !includes.call(data.agent, 'Googlebot/');
	}
}, {
	// Ignore errors send by yandexbot
	name: 'yandexBot',
	callback: function (data) {
		return !includes.call(data.agent, 'YandexBot/');
	}
}, {
	// Ignore errors saying that google API is not accessible (downtime of google)
	name: 'googleApi',
	callback: function (data) {
		return (data.errorMessage !== 'google is not defined');
	}
}, {
	// Ignore /dbupdate/ errors on public website.
	// App may want to sync data, but we have closed that channel to public website
	name: 'publicDbUpdate',
	callback: function (data) {
		if (this.req.$appName !== 'public') return true;
		if (data.errorMessage !== 'Rejected XHR request to "/dbupdate/": Not Found') return true;
	}
}, {
	// Ignore errors invoked most likely by extensions and not our codebase
	name: 'varsBlackList',
	callback: function (data) {
		if (this.req.$appName !== 'public') return true;
		return varsBlackList.every(function (name) {
			return (data.message !== 'Uncaught ReferenceError: ' + name + ' is not defined');
		});
	}
}, {
	// Ignore 3rd party script errors
	name: 'sourceBlackList',
	callback: function (data) {
		return sourceBlackList.every(function (name) { return !includes.call(data.source, name); });
	}
}, {
	// Ignore Chrome extension errors
	// http://stackoverflow.com/q/15113562/96806
	name: 'localErrChromeExt',
	callback: function (data) {
		if (data.source) return true;
		if (data.errorMessage) return true;
		if (!includes.call(data.agent, 'Chrome/')) return true;
		return (data.message !== 'Uncaught TypeError: Cannot read property \'local\' of undefined');
	}
}];
